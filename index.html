<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Traductor n8n</title>
  <style>
  :root{
    --bg1:#070712; --bg2:#0b1026;
    --cardA: rgba(255,255,255,.08);
    --cardB: rgba(255,255,255,.04);
    --stroke: rgba(255,255,255,.14);
    --stroke2: rgba(255,255,255,.10);

    --text:#f4f6ff;
    --muted: rgba(244,246,255,.70);

    --accent:#7c5cff;
    --accent2:#2ee59d;

    --danger:#ff6b6b;

    --shadow: 0 28px 90px rgba(0,0,0,.55);
    --shadow2: 0 14px 35px rgba(0,0,0,.28);

    --radius: 18px;
    --radius2: 14px;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }

  body{
    margin:0;
    font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
    color:var(--text);
    min-height:100vh;
    background:
      radial-gradient(1200px 600px at 12% 20%, rgba(124,92,255,.35), transparent 60%),
      radial-gradient(900px 500px at 85% 22%, rgba(46,229,157,.22), transparent 55%),
      radial-gradient(1000px 600px at 40% 95%, rgba(124,92,255,.16), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    padding: 28px 18px 48px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* contenedor m√°s ‚Äúaireado‚Äù */
  .wrap{ width:min(1020px, 100%); }

  .top{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:14px;
    margin-bottom: 16px;
  }

  .brand{ display:flex; gap:12px; align-items:center; }

  .logo{
    width:46px; height:46px;
    border-radius: 16px;
    background: linear-gradient(135deg, rgba(124,92,255,1), rgba(46,229,157,.78));
    box-shadow: 0 14px 38px rgba(124,92,255,.20);
    position: relative;
    overflow:hidden;
  }
  .logo:after{
    content:"";
    position:absolute; inset:-30%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 60%);
    transform: rotate(18deg);
  }

  h1{
    margin:0;
    font-size: 24px;
    letter-spacing:.2px;
    line-height:1.05;
  }
  .sub{
    margin:6px 0 0;
    color: var(--muted);
    font-size: 13.5px;
    line-height:1.35;
  }

  .pill{
    padding: 10px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,.07);
    border: 1px solid var(--stroke);
    color: rgba(244,246,255,.84);
    font-size: 12px;
    display:flex;
    gap:8px;
    align-items:center;
    box-shadow: var(--shadow2);
    backdrop-filter: blur(10px);
    white-space: nowrap;
  }
  .dot{
    width:8px; height:8px; border-radius:50%;
    background: var(--accent2);
    box-shadow: 0 0 0 6px rgba(46,229,157,.10);
  }

  /* Card con borde y brillo sutil */
  .card{
    background: linear-gradient(180deg, var(--cardA), var(--cardB));
    border: 1px solid var(--stroke2);
    border-radius: calc(var(--radius) + 2px);
    box-shadow: var(--shadow);
    overflow:hidden;
    backdrop-filter: blur(14px);
    position: relative;
  }
  .card:before{
    content:"";
    position:absolute;
    inset:0;
    pointer-events:none;
    background: radial-gradient(900px 260px at 18% 10%, rgba(124,92,255,.18), transparent 60%);
  }

  .toolbar{
    padding: 16px 16px 6px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    position: relative;
  }

  .controls{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
  }
  label{
    font-size: 12px;
    color: rgba(244,246,255,.72);
    margin-right: 2px;
  }

  select{
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(12,14,28,.55);
    color: var(--text);
    outline: none;
    min-width: 190px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    transition: border-color .15s ease, transform .05s ease;
  }
  select:focus{
    border-color: rgba(124,92,255,.55);
  }

  .btn{
    border:0;
    padding: 10px 14px;
    border-radius: 12px;
    font-weight: 750;
    letter-spacing:.2px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:10px;
    color: #0a0b12;
    background: linear-gradient(135deg, var(--accent), #a58cff);
    box-shadow: 0 14px 34px rgba(124,92,255,.22);
    transition: transform .08s ease, filter .15s ease, box-shadow .15s ease;
    user-select:none;
  }
  .btn:hover{ filter: brightness(1.03); }
  .btn:active{ transform: translateY(1px); }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }

  .btn.secondary{
    background: rgba(255,255,255,.08);
    color: var(--text);
    border: 1px solid rgba(255,255,255,.14);
    box-shadow: none;
  }

  .btn.ghost{
    background: rgba(255,255,255,.03);
    color: rgba(244,246,255,.92);
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: none;
  }

  /* WhatsApp */
  .btn.whatsapp{
    background: linear-gradient(135deg, #25D366, #1ebe5d);
    color: #062c1b;
    box-shadow: 0 14px 30px rgba(37,211,102,.16);
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    padding: 14px 16px 16px;
    position: relative;
  }

  @media (max-width: 860px){
    body{ padding: 18px 12px 34px; }
    .top{ align-items:flex-start; flex-direction:column; }
    .pill{ align-self:flex-start; }
    .grid{ grid-template-columns: 1fr; }
    select{ min-width: 170px; }
  }

  .panel{
    background: rgba(10,12,24,.48);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: var(--radius);
    padding: 12px;
    min-height: 240px;
    display:flex;
    flex-direction:column;
    gap: 10px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  }

  .panel h2{
    margin:0;
    font-size: 13px;
    color: rgba(244,246,255,.86);
    font-weight: 800;
    letter-spacing:.2px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .small{
    font-size: 12px;
    color: rgba(244,246,255,.62);
    font-weight: 600;
  }

  textarea{
    width:100%;
    flex: 1;
    resize: vertical;
    min-height: 160px;
    padding: 12px 12px;
    border-radius: var(--radius);
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(6,7,14,.55);
    color: var(--text);
    outline:none;
    line-height:1.45;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    transition: border-color .15s ease;
  }
  textarea:focus{
    border-color: rgba(124,92,255,.55);
  }

  .out{
    flex:1;
    padding: 12px;
    border-radius: var(--radius);
    border: 1px dashed rgba(255,255,255,.20);
    background: rgba(6,7,14,.40);
    white-space: pre-wrap;
    overflow:auto;
    min-height: 160px;
  }

  .status{
    padding: 12px 16px 14px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    border-top: 1px solid rgba(255,255,255,.10);
    color: rgba(244,246,255,.72);
    font-size: 12px;
    position: relative;
  }

  .error{ color: var(--danger); font-weight: 800; }
  .ok{ color: var(--accent2); font-weight: 800; }

  .spinner{
    width: 14px; height: 14px;
    border-radius: 50%;
    border: 2px solid rgba(10,11,18,.25);
    border-top-color: rgba(10,11,18,.95);
    display:inline-block;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .toast{
    position: fixed;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(15,18,34,.92);
    border: 1px solid rgba(255,255,255,.16);
    padding: 10px 12px;
    border-radius: 999px;
    color: rgba(244,246,255,.92);
    font-size: 12px;
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
    opacity: 0;
    pointer-events:none;
    transition: opacity .18s ease;
  }
  .toast.show{ opacity: 1; }
</style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Traductor n8n + IA</h1>
          <div class="sub">Escribe el texto, elige el idioma destino y obt√©n la traducci√≥n al instante.</div>
        </div>
      </div>
      <div class="pill"><span class="dot"></span>Webhook activo (producci√≥n)</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="controls">
          <label for="target">Idioma destino</label>
          <select id="target" title="Idioma destino">
            <option value="es">Espa√±ol (es)</option>
            <option value="en">Ingl√©s (en)</option>
            <option value="fr">Franc√©s (fr)</option>
            <option value="pt">Portugu√©s (pt)</option>
            <option value="de">Alem√°n (de)</option>
            <option value="it">Italiano (it)</option>
          </select>

          <button class="btn" id="btn" type="button">
            <span id="btnIcon">ü™Ñ</span>
            <span id="btnText">Traducir</span>
          </button>

          <button class="btn secondary" id="btnClear" type="button">Limpiar</button>

          <!-- Bot√≥n WhatsApp -->
          <button class="btn whatsapp" id="shareWa" type="button" title="Compartir por WhatsApp">
            üì≤ WhatsApp
          </button>
        </div>

        <div class="small" id="charCount">0 caracteres</div>
      </div>

      <div class="grid">
        <div class="panel">
          <h2>
            Texto original
            <span class="small">Tip: puedes pegar p√°rrafos largos</span>
          </h2>
          <textarea id="text" placeholder="Ej: Hello world..."></textarea>
        </div>

        <div class="panel">
          <h2>
            Traducci√≥n
            <button class="btn secondary" id="copy" type="button">Copiar</button>
          </h2>
          <div id="out" class="out"></div>
        </div>
      </div>

      <div class="status">
        <div id="statusLeft"></div>
        <div id="statusRight">Fuente: n8n Webhook + OpenAI</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Copiado ‚úÖ</div>

  <script>
    const WEBHOOK_URL = "https://sihat.app.n8n.cloud/webhook/translate";
    const WEBHOOK_SEND_EMAIL = "https://proxy-n8n-psi.vercel.app/api/send_email";

    const $ = (id) => document.getElementById(id);
    const btn = $("btn");
    const btnText = $("btnText");
    const btnIcon = $("btnIcon");
    const out = $("out");
    const statusLeft = $("statusLeft");
    const charCount = $("charCount");
    const toast = $("toast");

    function toastShow(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=> toast.classList.remove("show"), 1200);
    }

    function setLoading(isLoading){
      btn.disabled = isLoading;
      btnIcon.innerHTML = isLoading ? "<span class='spinner'></span>" : "ü™Ñ";
      btnText.textContent = isLoading ? "Traduciendo..." : "Traducir";
    }

    function safeText(s){ return (s ?? "").toString(); }

    $("text").addEventListener("input", () => {
      charCount.textContent = `${$("text").value.length} caracteres`;
    });

    $("btnClear").addEventListener("click", () => {
      $("text").value = "";
      out.textContent = "";
      statusLeft.textContent = "Listo.";
      charCount.textContent = "0 caracteres";
    });

    $("copy").addEventListener("click", async () => {
      const txt = out.textContent.trim();
      if (!txt) return toastShow("Nada para copiar");
      try{
        await navigator.clipboard.writeText(txt);
        toastShow("Copiado ‚úÖ");
      }catch{
        toastShow("No se pudo copiar");
      }
    });

    // ‚úÖ Compartir por WhatsApp (SOLO EL LINK)
    $("shareWa").addEventListener("click", () => {
      const url = window.location.href;  // esto ser√° tu link de GitHub Pages
      const waUrl = "https://wa.me/?text=" + encodeURIComponent(url);
      window.open(waUrl, "_blank");
    });

    btn.addEventListener("click", async () => {
      const text = $("text").value.trim();
      const target = $("target").value;

      if (!text){
        out.innerHTML = "<span style='color: var(--danger); font-weight:700;'>Escribe un texto para traducir.</span>";
        statusLeft.innerHTML = "<span class='error'>Falta texto.</span>";
        return;
      }

      setLoading(true);
      statusLeft.textContent = "Conectando al webhook...";

      try{
        const url = WEBHOOK_URL
          + "?text=" + encodeURIComponent(text)
          + "&target=" + encodeURIComponent(target);

        const res = await fetch(url, { method: "GET" });
        const data = await res.json().catch(()=> ({}));

        if (!res.ok || data.success === false){
          const msg = data.error || res.statusText || "Error desconocido";
          out.innerHTML = "<span class='error'>"+ safeText(msg) +"</span>";
          statusLeft.innerHTML = "<span class='error'>Error.</span>";
        } else {
          out.textContent = safeText(data.translation) || "(sin traducci√≥n)";
          statusLeft.innerHTML = "<span class='ok'></span> Traducido a <b>"+ safeText(data.target || target) +"</b>";
        }
      }catch(e){
        out.innerHTML = "<span class='error'>No se pudo conectar al webhook. Revisa que el workflow est√© activo y la URL sea de producci√≥n.</span>";
        statusLeft.innerHTML = "<span class='error'>Sin conexi√≥n.</span>";
      }finally{
        setLoading(false);
      }
    });
// ==========================
// ü§ñ Chat de ayuda (env√≠a correo con la traducci√≥n)
// ==========================

// Bot√≥n flotante
const helpBtn = document.createElement("button");
helpBtn.className = "btn ghost";
helpBtn.type = "button";
helpBtn.textContent = "üí¨ Ayuda";
helpBtn.style.cssText = "position:fixed; right:22px; bottom:22px; z-index:9999;";
document.body.appendChild(helpBtn);

// Caja del chat
const chatBox = document.createElement("div");
chatBox.style.cssText = `
  position:fixed; right:22px; bottom:78px; width:340px; height:460px; z-index:9999;
  background: rgba(15,18,34,.92);
  border: 1px solid rgba(255,255,255,.16);
  border-radius: 16px;
  box-shadow: 0 18px 50px rgba(0,0,0,.35);
  overflow:hidden;
  display:none;
  backdrop-filter: blur(12px);
`;

chatBox.innerHTML = `
  <div style="padding:12px 12px; font-weight:800; color:rgba(244,246,255,.95); border-bottom:1px solid rgba(255,255,255,.12); display:flex; justify-content:space-between; align-items:center;">
    <span>Asistente ü§ñ</span>
    <button id="chatClose" class="btn secondary" type="button" style="padding:6px 10px; border-radius:10px;">‚úï</button>
  </div>

  <div id="chatLog" style="padding:12px; height: 330px; overflow:auto; color: rgba(244,246,255,.95); font-size: 13.5px;"></div>

  <div style="display:flex; gap:8px; padding:12px; border-top:1px solid rgba(255,255,255,.12);">
    <input id="chatInput" placeholder="Escribe aqu√≠..." style="flex:1; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.16); background: rgba(6,7,14,.55); color: rgba(244,246,255,.95); outline:none;" />
    <button id="chatSend" class="btn" type="button" style="padding:10px 12px; border-radius:12px;">Enviar</button>
  </div>
`;
document.body.appendChild(chatBox);

const chatLog = document.getElementById("chatLog");
const chatInput = document.getElementById("chatInput");

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function addChat(role, text){
  const line = document.createElement("div");
  line.style.margin = "10px 0";
  line.innerHTML = `<b>${role}:</b> ${escapeHtml(text)}`;
  chatLog.appendChild(line);
  chatLog.scrollTop = chatLog.scrollHeight;
}

// Estado conversacional
let awaitingEmail = false;

function getOriginal(){ return $("text").value.trim(); }
function getTranslation(){ return out.textContent.trim(); }

function extractEmail(text){
  const m = text.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
  return m ? m[0] : null;
}

async function sendEmail(to){
  const original = getOriginal();
  const translation = getTranslation();

  if (!translation){
    addChat("Bot", "Primero genera una traducci√≥n (bot√≥n ‚ÄúTraducir‚Äù).");
    return;
  }

  addChat("Bot", `Enviando correo a ${to}...`);

  try{
    const url =
      WEBHOOK_SEND_EMAIL +
      "?to=" + encodeURIComponent(to) +
      "&subject=" + encodeURIComponent("Traducci√≥n desde Traductor n8n + IA") +
      "&original=" + encodeURIComponent(original) +
      "&translation=" + encodeURIComponent(translation);

    const res = await fetch(url, { method: "GET" });
    const data = await res.json().catch(()=> ({}));

    if (!res.ok || data.ok === false){
      addChat("Bot", "‚ùå No se pudo enviar el correo.");
      return;
    }

    addChat("Bot", "‚úÖ Correo enviado y guardado en Google Sheets.");
  }catch(e){
    addChat("Bot", "‚ùå Error de conexi√≥n.");
  }
}

function handleUserMessage(msg){
  if (awaitingEmail){
    const email = extractEmail(msg);
    if (!email){
      addChat("Bot", "No veo un correo v√°lido. Ej: persona@dominio.com");
      return;
    }
    awaitingEmail = false;
    sendEmail(email);
    return;
  }

  // intenci√≥n: enviar correo
  if (/(correo|email|mail|enviar|manda)/i.test(msg)){
    if (!getTranslation()){
      addChat("Bot", "A√∫n no hay traducci√≥n. Haz clic en ‚ÄúTraducir‚Äù y luego dime: ‚Äúenv√≠alo por correo‚Äù.");
      return;
    }
    awaitingEmail = true;
    addChat("Bot", "Perfecto. ¬øA qu√© correo lo env√≠o? (ej: persona@dominio.com)");
    return;
  }

  addChat("Bot", "Puedo enviar la traducci√≥n por correo. Escribe: ‚Äúenviar por correo‚Äù.");
}

function sendChat(){
  const msg = chatInput.value.trim();
  if (!msg) return;
  chatInput.value = "";
  addChat("T√∫", msg);
  handleUserMessage(msg);
}

helpBtn.addEventListener("click", () => {
  const isOpen = chatBox.style.display === "block";
  chatBox.style.display = isOpen ? "none" : "block";

  if (!isOpen && !chatBox.dataset.greeted){
    chatBox.dataset.greeted = "1";
    addChat("Bot", "Hola üôÇ Puedo ayudarte a enviar la traducci√≥n por correo. Escribe: ‚Äúenviar por correo‚Äù.");
  }
  setTimeout(()=> chatInput.focus(), 50);
});

document.getElementById("chatClose").addEventListener("click", () => {
  chatBox.style.display = "none";
});

document.getElementById("chatSend").addEventListener("click", sendChat);

chatInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") sendChat();
});
  </script>
</body>
</html>

